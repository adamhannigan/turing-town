# Runs every minute: triages open issues, assigns ready ones to Copilot.
# Requires secret COPILOT_ASSIGN_PAT (Fine-grained PAT with Issues: R/W, from a Copilot-licensed user).
# Also run manually from Actions tab via "Run workflow".

name: Agent â€“ Issue handling

on:
  schedule:
    - cron: '* * * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  process-issues:
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.triage.outputs.issue_number }}
    steps:
      - name: Triage and find issue ready for Copilot
        id: triage
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const api = github.rest;

            const { data: issues } = await api.issues.listForRepo({
              owner, repo, state: 'open', sort: 'created', direction: 'asc', per_page: 20,
            });

            const labelNames = (issue) => (issue.labels || []).map((l) => l.name);
            const has = (issue, name) => labelNames(issue).includes(name);

            for (const issue of issues) {
              if (issue.pull_request) continue;
              if (has(issue, 'agent-done')) continue;

              const body = (issue.body || '').trim();
              const bodyLong = body.length >= 80;
              const hasNeedsDetails = has(issue, 'needs-details');
              const hasAck = has(issue, 'agent-acknowledged');
              const hasInProgress = has(issue, 'agent-in-progress');

              if (!bodyLong && !hasNeedsDetails) {
                await api.issues.addLabels({ owner, repo, issue_number: issue.number, labels: ['needs-details'] });
                await api.issues.createComment({
                  owner, repo, issue_number: issue.number,
                  body: `ðŸ‘‹ Thanks for opening this issue. To help the agent implement it, please add a bit more detail:\n\n` +
                    `- **Bug:** Steps to reproduce, expected vs actual behavior, and environment (browser/OS).\n` +
                    `- **Feature:** What you want to see, where it should appear (e.g. HUD, new building type), and any constraints.\n\n` +
                    `Reply here with the details and we'll pick it up.`,
                });
                console.log(`Issue #${issue.number}: added needs-details`);
                return;
              }

              if (hasNeedsDetails) {
                const { data: comments } = await api.issues.listComments({ owner, repo, issue_number: issue.number });
                const lastUserComment = comments.filter(c => !c.user?.login?.includes('[bot]')).pop();
                const commentBody = (lastUserComment?.body || '').trim();
                if (commentBody.length >= 40) {
                  await api.issues.removeLabel({ owner, repo, issue_number: issue.number, name: 'needs-details' });
                  await api.issues.addLabels({ owner, repo, issue_number: issue.number, labels: ['agent-acknowledged'] });
                  await api.issues.createComment({
                    owner, repo, issue_number: issue.number,
                    body: `âœ… **Thanks for the details.** The agent will work on this. You'll get another update when work has started and when it's done.`,
                  });
                  console.log(`Issue #${issue.number}: acknowledged after comment`);
                  return;
                }
                return;
              }

              if (bodyLong && !hasAck) {
                await api.issues.addLabels({ owner, repo, issue_number: issue.number, labels: ['agent-acknowledged'] });
                await api.issues.createComment({
                  owner, repo, issue_number: issue.number,
                  body: `âœ… **Acknowledged.** The agent will work on this. You'll get another update when work has started and when it's done.`,
                });
                console.log(`Issue #${issue.number}: acknowledged`);
                return;
              }

              // Ready for Copilot: output issue number and stop (do not mark done here; auto-merge workflow will do that when PR is merged)
              if (hasAck && !hasInProgress && !has(issue, 'agent-done')) {
                core.setOutput('issue_number', String(issue.number));
                console.log(`Issue #${issue.number}: ready for Copilot (output set)`);
                return;
              }
            }
            console.log('No issue needed an action this run.');

      - name: Assign issue to Copilot
        if: steps.triage.outputs.issue_number != '' && secrets.COPILOT_ASSIGN_PAT != ''
        env:
          GH_TOKEN: ${{ secrets.COPILOT_ASSIGN_PAT }}
          ISSUE_NUMBER: ${{ steps.triage.outputs.issue_number }}
        run: |
          gh issue edit "$ISSUE_NUMBER" --repo "$GITHUB_REPOSITORY" --add-assignee "@copilot"
          echo "Assigned issue #${ISSUE_NUMBER} to @copilot"

      - name: Mark in progress and comment
        if: steps.triage.outputs.issue_number != ''
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.triage.outputs.issue_number }}
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER, 10);
            const { owner, repo } = context.repo;
            await github.rest.issues.addLabels({
              owner, repo, issue_number: issueNumber, labels: ['agent-in-progress'],
            });
            await github.rest.issues.createComment({
              owner, repo, issue_number: issueNumber,
              body: `ðŸ”§ **Assigned to Copilot.** The coding agent will create a PR for this issue. When the PR is ready and passes checks, it will be merged automatically.`,
            });
