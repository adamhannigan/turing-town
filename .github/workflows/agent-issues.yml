# When an issue is opened (or commented on after "needs-details"),
# acknowledge it, ask for more info if needed, then run the agent workflow.
# The agent step is a placeholder that posts status; you can replace it with
# a job that triggers your Copilot Coding Agent or runs a script that creates a PR.

name: Agent â€“ Issue handling

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  triage:
    runs-on: ubuntu-latest
    outputs:
      run_agent: ${{ steps.agent_trigger.outputs.run_agent }}
    if: github.event_name == 'issues' || (github.event_name == 'issue_comment' && github.event.issue.state == 'open')
    steps:
      - name: Check for needs-details
        id: needs_details
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            # Only react when someone (e.g. issue author) comments on an issue we asked for details on
            echo "is_comment=true" >> $GITHUB_OUTPUT
          else
            echo "is_comment=false" >> $GITHUB_OUTPUT
          fi

      - name: Fetch issue and labels
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue || context.payload.issue;
            const body = (issue && issue.body) || '';
            const labels = (issue && issue.labels || []).map(l => l.name);
            const hasNeedsDetails = labels.includes('needs-details');
            const commentCount = issue ? (issue.comments || 0) : 0;
            const isCommentEvent = context.eventName === 'issue_comment';
            const hasEnoughDetail = body && body.length > 80 && !body.toLowerCase().includes('n/a') && !body.toLowerCase().includes('todo');
            core.setOutput('number', issue?.number ?? 0);
            core.setOutput('body', body);
            core.setOutput('body_length', body.length);
            core.setOutput('has_needs_details', hasNeedsDetails);
            core.setOutput('has_enough_detail', hasEnoughDetail);
            core.setOutput('is_comment', isCommentEvent ? 'true' : 'false');
            core.setOutput('user', context.payload.sender?.login || context.payload.issue?.user?.login || '');

      - name: Add needs-details label and comment when details missing (issue opened)
        if: github.event_name == 'issues' && github.event.action == 'opened' && steps.issue.outputs.body_length < 80
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['needs-details']
            });
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `ðŸ‘‹ Thanks for opening this issue. To help the agent implement it, please add a bit more detail:\n\n` +
                `- **Bug:** Steps to reproduce, expected vs actual behavior, and environment (browser/OS).\n` +
                `- **Feature:** What you want to see, where it should appear (e.g. HUD, new building type), and any constraints.\n\n` +
                `Reply here with the details and weâ€™ll pick it up.`
            });

      - name: Acknowledge issue (opened, enough detail)
        if: github.event_name == 'issues' && steps.issue.outputs.body_length >= 80
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['agent-acknowledged']
            });
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `âœ… **Acknowledged.** The agent will work on this. Youâ€™ll get another update when work has started and when itâ€™s done.`
            });

      - name: Remove needs-details and acknowledge (new comment with enough detail)
        if: github.event_name == 'issue_comment' && steps.issue.outputs.has_needs_details == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const commentBody = (context.payload.comment && context.payload.comment.body) || '';
            if (commentBody.length < 40) return;
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              name: 'needs-details'
            });
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['agent-acknowledged']
            });
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `âœ… **Thanks for the details.** The agent will work on this. Youâ€™ll get another update when work has started and when itâ€™s done.`
            });

      - name: Set run_agent output for work job
        id: agent_trigger
        run: |
          BODY_LEN="${{ steps.issue.outputs.body_length }}"
          NEEDS_DETAILS="${{ steps.issue.outputs.has_needs_details }}"
          if [ "${{ github.event_name }}" = "issues" ] && [ "${{ github.event.action }}" = "opened" ] && [ -n "$BODY_LEN" ] && [ "$BODY_LEN" -ge 80 ]; then
            echo "run_agent=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "issue_comment" ] && [ "$NEEDS_DETAILS" = "true" ]; then
            echo "run_agent=true" >> $GITHUB_OUTPUT
          else
            echo "run_agent=false" >> $GITHUB_OUTPUT
          fi

  work:
    needs: triage
    runs-on: ubuntu-latest
    if: needs.triage.outputs.run_agent == 'true'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment â€“ Working on it
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `ðŸ”§ **Working on this.** The agent is processing the issue. Youâ€™ll get a follow-up when a PR is ready or the task is done.`
            });
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['agent-in-progress']
            });

      # Placeholder: replace with a step that runs your agent (e.g. script that creates branch + PR, or calls external API).
      - name: Agent placeholder (create branch / PR here)
        run: |
          echo "Replace this step with your Copilot Coding Agent or a script that:"
          echo "  1. Creates a branch (e.g. issue-<number>-slug)"
          echo "  2. Applies the fix or feature per agents/context/game-rules.md"
          echo "  3. Opens a PR that references this issue (Fixes #<number>)"
          echo "Then add a final step that comments 'Done in PR #X' when the PR is opened."

      - name: Comment â€“ Ticket done (placeholder)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `âœ… **Ticket handled.** When you wire the agent step above to create a real PR, this comment will link it (e.g. "Done in PR #123").`
            });
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              name: 'agent-in-progress'
            });
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['agent-done']
            });
</think>
Fixing the workflow: correcting the `work` job's `if` and fixing the duplicate `needs`/`if` at the end.
<ï½œtoolâ–callsâ–beginï½œ><ï½œtoolâ–callâ–beginï½œ>
Read