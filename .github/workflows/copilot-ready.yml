# When Copilot opens a draft PR (or updates it), mark it ready for review.
# Then copilot-auto-merge.yml can enable auto-merge so it merges when checks pass.

name: Mark Copilot PRs ready

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  pull-requests: write

jobs:
  mark-ready:
    runs-on: ubuntu-latest
    # Only for Copilot-created PRs that are still draft
    if: github.event.pull_request.user.login == 'github-copilot[bot]' && github.event.pull_request.draft == true
    steps:
      - name: Mark PR ready for review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          PR_ID=$(gh api graphql -f query='
            query($owner:String!, $name:String!, $number:Int!) {
              repository(owner:$owner, name:$name) {
                pullRequest(number:$number) { id }
              }
            }' -F owner="${REPO%/*}" -F name="${REPO#*/}" -F number="$PR_NUMBER" --jq '.data.repository.pullRequest.id')

          gh api graphql -f query='
            mutation($pullRequestId:ID!) {
              markPullRequestReadyForReview(input:{pullRequestId:$pullRequestId}) {
                pullRequest { number, isDraft }
              }
            }' -F pullRequestId="$PR_ID"
