# When a PR that references an issue (e.g. "Fixes #1") is ready, enable GitHub auto-merge.
# With "Allow auto-merge" enabled in repo settings, GitHub will merge when checks (and reviews) pass.
# When the PR is actually merged, on-merged-close-issue.yml will comment and close the issue.

name: Auto-merge Copilot PRs

on:
  schedule:
    - cron: '*/5 * * * *'
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write
  contents: read

jobs:
  enable-auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Enable auto-merge on PRs that fix an issue
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const api = github.rest;

            const { data: prs } = await api.pulls.list({
              owner, repo, state: 'open', base: 'main', sort: 'created', direction: 'asc', per_page: 20,
            });

            const fixesIssue = (body, title) => {
              const text = [body, title].filter(Boolean).join(' ');
              const match = text.match(/(?:fixes?|closes?|resolves?)\s+#(\d+)/i);
              return match ? parseInt(match[1], 10) : null;
            };

            for (const pr of prs) {
              const issueNumber = fixesIssue(pr.body, pr.title);
              if (!issueNumber) continue;

              const { data: full } = await api.pulls.get({ owner, repo, pull_number: pr.number });
              if (full.draft) continue;

              const { repository } = await github.graphql(`
                query($owner: String!, $repo: String!, $number: Int!) {
                  repository(owner: $owner, name: $repo) {
                    pullRequest(number: $number) { id autoMergeRequest { enabledAt } }
                  }
                }
              `, { owner, repo, number: pr.number });
              const pullRequestId = repository.pullRequest.id;
              if (repository.pullRequest.autoMergeRequest?.enabledAt) continue;

              await github.graphql(`
                mutation($id: ID!) {
                  enablePullRequestAutoMerge(input: { pullRequestId: $id, mergeMethod: MERGE }) {
                    pullRequest { autoMergeRequest { enabledAt } }
                  }
                }
              `, { id: pullRequestId });
            core.info('Enabled auto-merge on PR #' + pr.number + ' (Fixes #' + issueNumber + ').');
              return;
            }
            core.info('No PR needed auto-merge this run.');
