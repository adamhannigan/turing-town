# When a PR that references an issue (e.g. "Fixes #1") is ready and mergeable, merge it and close the issue.
# Runs every 5 minutes and when PRs are updated.
#
# Branch protection: If "Require a pull request before merging" or "Require review" blocks merges,
# either add your merge user to "Allow specified actors to bypass required pull requests" in
# Settings → Branches → main → Edit, or set MERGE_PAT to a PAT from a user who has bypass.

name: Auto-merge Copilot PRs

on:
  schedule:
    - cron: '*/5 * * * *'
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  merge:
    runs-on: ubuntu-latest
    steps:
      - name: Find and merge one mergeable PR that fixes an issue
        uses: actions/github-script@v7
        with:
          # Use MERGE_PAT (repo admin PAT) if branch protection requires approval, so merge bypasses it
          token: ${{ secrets.MERGE_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const api = github.rest;

            const { data: prs } = await api.pulls.list({
              owner, repo, state: 'open', base: 'main', sort: 'created', direction: 'asc', per_page: 20,
            });

            const fixesIssue = (body, title) => {
              const text = [body, title].filter(Boolean).join(' ');
              const match = text.match(/(?:fixes?|closes?|resolves?)\s+#(\d+)/i);
              return match ? parseInt(match[1], 10) : null;
            };

            for (const pr of prs) {
              const issueNumber = fixesIssue(pr.body, pr.title);
              if (!issueNumber) continue;

              const { data: full } = await api.pulls.get({ owner, repo, pull_number: pr.number });
              if (full.draft) continue; // only merge when marked ready for review (not draft)
              if (full.mergeable !== true || full.mergeable_state !== 'clean') continue;

              await api.pulls.merge({
                owner, repo, pull_number: pr.number, merge_method: 'merge',
              });
            core.info(`Merged PR #${pr.number} (Fixes #${issueNumber})`);

              await api.issues.createComment({
                owner, repo, issue_number: issueNumber,
                body: `✅ **Done.** Merged in PR #${pr.number}.`,
              });
              await api.issues.removeLabel({
                owner, repo, issue_number: issueNumber, name: 'agent-in-progress',
              }).catch(() => {});
              await api.issues.addLabels({
                owner, repo, issue_number: issueNumber, labels: ['agent-done'],
              });
              await api.issues.update({
                owner, repo, issue_number: issueNumber, state: 'closed',
              });
              return;
            }
            core.info('No mergeable PR found this run.');
